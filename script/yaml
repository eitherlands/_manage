#!/usr/bin/env bash
#
# vim: set ft=sh:
#
# <doc>
#
# YAML-like parser
#
# </doc>
#
# <import>
#
# collection-shell
#
# </import>
#

parseyaml() {
    _ required "$1" ||
        return 1

    local s
    local w
    local fs
    local p

    p="$2"
    s='[[:space:]]*'
    w='[a-zA-Z0-9_]*'
    fs="$(echo @|tr @ '\034')"

    sed -ne "s|^\($s\)\($w\)$s:$s\"\(.*\)\"$s\$|\1$fs\2$fs\3|p" \
        -e "s|^\($s\)\($w\)$s[:-]$s\(.*\)$s\$|\1$fs\2$fs\3|p" "$1" |

    awk -F"$fs" '{
        indent = length($1)/2;
        vname[indent] = $2;
        for (i in vname) {if (i > indent) {delete vname[i]}}
            if (length($3) > 0) {
                vn=""; for (i=0; i<indent; i++) {vn=(vn)(vname[i])("_")}
                printf("%s%s%s=(\"%s\")\n", "'"$p"'",vn, $2, $3);
            }
    }' |
    sed 's/_=/+=/g'                     |
    sed 's/[[:space:];]/\n/g'           |
    grep -E '^[a-zA-Z0-9_]+(\+\=|\=)\(\".+\"\)'   |
    sed 's/[a-zA-Z0-9_]\+[\+\=]/\U&/g'
}

yaml () {
    _ required "$1" "$2" ||
        return 1

    local yaml="$1"
    local variables
    shift

    variables=($(echo "${yaml}" |
                sed 's/+=.*$//' |
                sed 's/=.*$//'  |
                sort -u))

    for variable in "${variables[@]}"
    do
        for argument in "$@"
        do
            if [[ "$(echo "${argument}" | _ upper )" == "${variable}" ]]
            then
                echo "local ${variable}"
                echo "${yaml}" |
                grep -E "^${variable}(\+\=|\=)"
            fi
        done
    done
}

main () {
    YAML="$(parseyaml "${MANAGEDIRECTORY}"/.manage.yml)"
    eval "$(yaml "${YAML}" default strict qweqwe dependencies)"
    echo "${DEFAULT}"
    echo "${DEPENDENCIES[@]}"
}
