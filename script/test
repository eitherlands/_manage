#!/usr/bin/env manage
#
# vim: set ft=sh:
#
# <doc>
#
# Run the test suite.
#
# </doc>
#
# <import>
#
# collection-shell
# collection-message
#
# </import>
#
# <dependency>
#
# bats
#
# </dependency>

main () {
    local name
    local file
    local testdirectory
    export MANAGEDIRECTORY
    export MANAGEREPOSITORY

    #TODO: variable test directory
    testdirectory="$(_expandpath "${MANAGEREPOSITORY}/test")"

    if [ -d "${testdirectory}" ]
    then
        if _required "${1}"
        then
            for file in "${testdirectory}"/*.bats
            do
                if [   -f "${file}" ] &&
                   [   -r "${file}" ]
                   [[ "$(basename "${file}")" == *.bats ]]
                then
                    name="$(basename "${file}")"
                    if [[ "${1}" == "${name::-5}" ]]
                    then
                        bats "$(_truthEcho "${CI}" "--tap" "--pretty")" "${file}"
                    fi
                fi
            done
            cd "${OPWD}" || exit
        else
            bats "$(_truthEcho "${CI}" "--tap" "--pretty")" "${testdirectory}"
        fi
    else
        _die "No tests, aborting."
    fi
}

