#!/usr/bin/env bash

[[ $LIBEXEC_MANAGE_LOADED ]] && return

source libexec-functions
source libexec-arguments
# source libexec-yaml

runhelp ()
{
    if exists "help"
    then
        prepare "help" "$@"
    elif exists "_manage_help"
    then
        prepare "_manage_help" "$@"
    fi
}

runcomplete ()
{
    if exists "completion"
    then
        prepare "completion" "$@"
    elif exists "_manage_completion"
    then
        prepare "_manage_completion" "$@"
    fi
}

run () {
    local name="$1"
    shift

    case name in
        completion)
            runcomplete "$@"
            ;;
        help)
            runhelp "$@"
            ;;
        *)
            if exists "${name}"
            then
                prepare "${name}" "$@"
            else
                runhelp
            fi
    esac
}


prepare () {
    local name
    local path
    local imports

    name="${1}"
    path="$(getpath "${name}")"
    imports=($(_ embeddedTag "import" "${path}"))

    shift

    checkdependencies "${path}"

    if isinternal "${name}"
    then
        __ import "${imports[*]}"
        source "${path}"
        main "$@"
    else
        local zero
        local exports
        local commandstring
        zero="$(basename "${MANAGEZERO}")"
        libexec="source \"${MANAGEDIRECTORY}/libexec/manage\""

        exports="MANAGEDIRECTORY=\"${MANAGEDIRECTORY}\"
                 MANAGEREPOSITORY=\"${MANAGEREPOSITORY}\"
                 MANAGESCRIPTPATH=\"${path}\"
                 MANAGEZERO=\"${MANAGEZERO}\"
                 MANAGEIMPORT=\"$(_ join " " "${imports[@]}")\""

        commandstring="$(echo "${exports} && ${libexec}" | _ squeeze | tr '\n' ' ')"

        (
            exec -a "${zero}"         \
                "bash"                  \
                "--norc"                \
                "--noprofile"           \
                "-c" "${commandstring}" \
                "${zero}"             \
                "$@"
        ) || exit $?
    fi
}

LIBEXEC_MANAGE_LOADED=1

